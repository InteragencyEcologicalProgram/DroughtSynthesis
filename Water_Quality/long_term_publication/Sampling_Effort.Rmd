---
title: "Long-term WQ: Sampling Effort"
author: "Dave Bosworth"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

Look at the sampling effort for the various WQ parameters to be included in the long-term WQ publication. Here are some notes and issues to consider:

Notable differences between `raw_chla_1975_2021` (from `DroughtData`) and the data used by the Primary Producers group:

1) `raw_chla_1975_2021` includes the four EZ stations from EMP
2) `raw_chla_1975_2021` has data for November 2021
3) `raw_chla_1975_2021` has additional Chlorophyll_Sign column that indicates whether the chlorophyll-a value is above or below the RL. For the 3 values that are below the RL, `raw_chla_1975_2021` reports them as equal to the RL, while the data from the Primary Producers group reports them as half the RL.

Things to consider with the nutrient, chlorophyll-a, and WQ data sets:

1) The chlorophyll-a data set includes the Grant Line Canal and Old River subregion. Should this region be included in the nutrient and WQ data sets?
2) The chlorophyll-a data set is not filtered to remove records where `Long_term == FALSE`, while those records are removed from the nutrient and WQ data sets. We may want to make these all consistent.

So far, these are the surveys included in this summary:

* **Water Temperature, Salinity, Secchi depth:** EMP, STN, FMWT
* **Nutrients:** EMP, USGS_SFBS, USGS_CAWSC (just 11447650 - Sacramento River at Freeport)
* **Chlorophyll-a:** EMP, USGS_SFBS

# Global code and functions

```{r load packages, message = FALSE, warning = FALSE}
# Load packages
library(tidyverse)
library(lubridate)
library(scales)
library(DroughtData)
```


# Import and Prepare Data

```{r prepare data}
# Create a nested data frame and prepare to run the summary plot function on
ndf_lt_wq <- 
  tibble(
    Parameter = c(
      "Temperature",
      "Salinity",
      "Secchi",
      "DissAmmonia",
      "DissNitrateNitrite",
      "DissOrthophos",
      "Chlorophyll"
    ),
    df_data = c(
      rep(list(raw_wq_1975_2021), 3),
      rep(list(raw_nutr_1975_2021), 3),
      list(raw_chla_1975_2021)
    )
  ) %>% 
  mutate(
    df_data_c = map(
      df_data,
      ~mutate(
        .x,
        Month = fct_rev(month(Date, label = TRUE)),
        Region = factor(
          Region,
          levels = c(
            "North",
            "SouthCentral",
            "Confluence",
            "Suisun Bay",
            "Suisun Marsh"
          )
        ),
         YearAdj = factor(YearAdj)
      )
    )
  )
```

# Create Plots

```{r plot func}
# Create function for sampling effort plots
plot_samp_effort <- function(df, param) {
  df %>% 
    drop_na(.data[[param]]) %>% 
    count(YearAdj, Month, Region, name = "num_samples") %>% 
    ggplot(aes(x = YearAdj, y = Month, fill = num_samples)) +
    geom_tile() +
    facet_grid(rows = vars(Region), drop = FALSE) +
    scale_x_discrete(drop = FALSE) +
    scale_y_discrete(drop = FALSE) +
    scale_fill_viridis_c(name = "Number of Samples") +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
      legend.position = "top"
    )
}
```

```{r create plots}
# Create plots for each Parameter
ndf_lt_wq_plt <- ndf_lt_wq %>% mutate(plt = map2(df_data_c, Parameter, .f = plot_samp_effort))
```

# Sampling Effort {.tabset .tabset-pills}

```{r print plots, echo = FALSE, results = "asis", fig.width = 8.5, fig.height = 9}
for (i in 1:nrow(ndf_lt_wq_plt)) {
  # Create subheadings for each Parameter
  cat("## ", ndf_lt_wq_plt$Parameter[i], "\n\n")
  # Print plot
  print(ndf_lt_wq_plt$plt[[i]])
  cat("\n\n")
}
```

