```{r}
# Title: Exploratory analysis of WQ data
# Purpose: determine best regressions to use for the drought synthesis project
# Author: Sarah Perry
# Contact: sarah.perry@water.ca.gov
```

```{r}
library(car)
library(english)
library(tseries)
library(tidyverse)
library(lubridate)
library(emmeans)
source('Water_Quality/wq_funcs.R')
```

# Read in Data
```{r message = FALSE}
# will eventually be the combined dataset
df_wq <- read_csv(drought_abs_path('WQ_Team/processed_data/combined_wq_data.csv'))

# simplify to drought/wet
df_wq$WY[df_wq$WY %in% c('not drought', 'in between')] <- 'wet'
df_wq$WY[df_wq$WY %in% c('drought no barrier', 'drought with barrier')] <- 'drought'

df_wq$Year <- format(df_wq$Date, '%Y')
```

```{r}
# Seasonal
df_wq_seasonal <- df_wq %>%
  group_by(Year, WY, Season) %>%
  summarise_at(c('DissNitrateNitrite', 'DissOrthophos', 'DissSilica'), mean, na.rm = TRUE)

df_wq_seasonal$DissNitrateNitrite <- log10(df_wq_seasonal$DissNitrateNitrite)
df_wq_seasonal$DissOrthophos <- log10(df_wq_seasonal$DissOrthophos)

# df_wq_seasonal <- season_to_num(df_wq_seasonal)

df_wq_seasonal$Year_Season <- paste0(df_wq_seasonal$Year,'/',df_wq_seasonal$Season)
df_wq_seasonal$Year_Season <- ym(df_wq_seasonal$Year_Season)
```

# Seasonal Averages for Entire Delta (DissNitrateNitrite)
```{r}
print('TEST THINGS')
lm_seasonal <- lm(DissNitrateNitrite ~ WY + Season, data = df_wq_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_wq_seasonal$DissNitrateNitrite_onelag <- lag(df_wq_seasonal$DissNitrateNitrite, n = 1L)
df_wq_seasonal$DissNitrateNitrite_twolag <- lag(df_wq_seasonal$DissNitrateNitrite, n = 2L)
df_wq_seasonal$DissNitrateNitrite_threelag <- lag(df_wq_seasonal$DissNitrateNitrite, n = 3L)

lm_seasonal <- lm(DissNitrateNitrite ~ WY + Season + DissNitrateNitrite_onelag + DissNitrateNitrite_twolag, data = df_wq_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))

print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_seasonal)

aov_seasonal <- Anova(lm_seasonal, type = 'II', test.statistic = 'F')
print(aov_seasonal)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_seas_seas <- emmeans(lm_seasonal, specs = pairwise ~ Season:Season, adjust = 'sidak')
print(test(emm_seas_seas)$contrasts)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_seas_WY <- emmeans(lm_seasonal, specs = pairwise ~ WY:WY, adjust = 'sidak')
print(test(emm_seas_WY)$contrasts)
```

# Seasonal Averages for Entire Delta (DON)
```{r}
# print('TEST THINGS')
# lm_seasonal <- lm(DON ~ WY + Season, data = df_wq_seasonal)
# 
# pacf(residuals(lm_seasonal), na.action = na.pass)
# 
# print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
# 
# print('')
# print('END TEST THINGS')
# print('')
# 
# # failed tests, add lags based on pacf
# df_wq_seasonal$DON_onelag <- lag(df_wq_seasonal$DON, n = 1L)
# df_wq_seasonal$DON_twolag <- lag(df_wq_seasonal$DON, n = 2L)
# df_wq_seasonal$DON_threelag <- lag(df_wq_seasonal$DON, n = 3L)
# df_wq_seasonal$DON_fourlag <- lag(df_wq_seasonal$DON, n = 4L)
# 
# lm_seasonal <- lm(DON ~ WY + Season + DON_onelag + DON_twolag + DON_threelag + DON_fourlag, data = df_wq_seasonal)
# 
# pacf(residuals(lm_seasonal), na.action = na.pass)
# 
# print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
# 
# print('')
# print('*-*-*-*-*-*-*')
# print('')
# 
# plot(lm_seasonal)
# 
# aov_seasonal <- Anova(lm_seasonal, type = 'II', test.statistic = 'F')
# print(aov_seasonal)
# 
# print('')
# print('*-*-*-*-*-*-*')
# print('')
# 
# emm_seas_seas <- emmeans(lm_seasonal, specs = pairwise ~ Season:Season, adjust = 'sidak')
# print(test(emm_seas_seas)$contrasts)
# 
# print('')
# print('*-*-*-*-*-*-*')
# print('')
# 
# emm_seas_WY <- emmeans(lm_seasonal, specs = pairwise ~ WY:WY, adjust = 'sidak')
# print(test(emm_seas_WY)$contrasts)
```

# Seasonal Averages for Entire Delta (DissOrthophos)
```{r}
print('TEST THINGS')
lm_seasonal <- lm(DissOrthophos ~ WY + Season, data = df_wq_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_wq_seasonal$DissOrthophos_onelag <- lag(df_wq_seasonal$DissOrthophos, n = 1L)
df_wq_seasonal$DissOrthophos_twolag <- lag(df_wq_seasonal$DissOrthophos, n = 2L)

lm_seasonal <- lm(DissOrthophos ~ WY + Season + DissOrthophos_onelag + DissOrthophos_twolag, data = df_wq_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_seasonal)

aov_seasonal <- Anova(lm_seasonal, type = 'II', test.statistic = 'F')
print(aov_seasonal)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_seas_seas <- emmeans(lm_seasonal, specs = pairwise ~ Season:Season, adjust = 'sidak')
print(test(emm_seas_seas)$contrasts)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_seas_WY <- emmeans(lm_seasonal, specs = pairwise ~ WY:WY, adjust = 'sidak')
print(test(emm_seas_WY)$contrasts)
```

# Seasonal Averages for Entire Delta (DissSilica)
```{r}
print('TEST THINGS')
lm_seasonal <- lm(DissSilica ~ WY + Season, data = df_wq_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

lm_seasonal <- lm(DissSilica ~ WY + Season, data = df_wq_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_seasonal)

aov_seasonal <- Anova(lm_seasonal, type = 'II', test.statistic = 'F')
print(aov_seasonal)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_seas_seas <- emmeans(lm_seasonal, specs = pairwise ~ Season:Season, adjust = 'sidak')
print(test(emm_seas_seas)$contrasts)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_seas_WY <- emmeans(lm_seasonal, specs = pairwise ~ WY:WY, adjust = 'sidak')
print(test(emm_seas_WY)$contrasts)
```

```{r}
# Regional
df_wq_regional <- df_wq %>%
  group_by(Year, SubRegion, WY) %>%
  summarise_at(c('DissNitrateNitrite', 'DissOrthophos', 'DissSilica'), mean, na.rm = TRUE)

df_wq_regional$DissNitrateNitrite <- log10(df_wq_regional$DissNitrateNitrite)
# df_wq_regional$DON <- log10(df_wq_regional$DON)
df_wq_regional$DissOrthophos <- log10(df_wq_regional$DissOrthophos)
```

# Regional Averages per Year (DissNitrateNitrite)
```{r}
print('TEST THINGS')
lm_regional <- lm(DissNitrateNitrite ~ WY + SubRegion, data = df_wq_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_wq_regional$DissNitrateNitrite_onelag <- lag(df_wq_regional$DissNitrateNitrite, n = 1L)
df_wq_regional$DissNitrateNitrite_twolag <- lag(df_wq_regional$DissNitrateNitrite, n = 2L)
df_wq_regional$DissNitrateNitrite_threelag <- lag(df_wq_regional$DissNitrateNitrite, n = 3L)
df_wq_regional$DissNitrateNitrite_fourlag <- lag(df_wq_regional$DissNitrateNitrite, n = 4L)

lm_regional <- lm(DissNitrateNitrite ~ WY + SubRegion + DissNitrateNitrite_onelag + DissNitrateNitrite_twolag + DissNitrateNitrite_threelag + DissNitrateNitrite_fourlag, data = df_wq_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_regional)

aov_regional <- Anova(lm_regional, type = 'II', test.statistic = 'F')
print(aov_regional)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_reg_reg <- emmeans(lm_regional, specs = pairwise ~ SubRegion:SubRegion, adjust = 'sidak')
print(test(emm_reg_reg)$contrasts)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_reg_WY <- emmeans(lm_regional, specs = pairwise ~ WY:WY, adjust = 'sidak')
print(test(emm_reg_WY)$contrasts)
```

# Regional Averages per Year (DON)
```{r}
# print('TEST THINGS')
# lm_regional <- lm(DON ~ WY + SubRegion, data = df_wq_regional)
# 
# pacf(residuals(lm_regional), na.action = na.pass)
# 
# print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
# 
# print('')
# print('END TEST THINGS')
# print('')
# 
# # failed tests, add lags based on pacf
# df_wq_regional$DON_onelag <- lag(df_wq_regional$DON, n = 1L)
# df_wq_regional$DON_twolag <- lag(df_wq_regional$DON, n = 2L)
# df_wq_regional$DON_threelag <- lag(df_wq_regional$DON, n = 3L)
# df_wq_regional$DON_fourlag <- lag(df_wq_regional$DON, n = 4L)
# 
# lm_regional <- lm(DON ~ WY + SubRegion + DON_onelag + DON_twolag + DON_threelag + DON_fourlag, data = df_wq_regional)
# 
# pacf(residuals(lm_regional), na.action = na.pass)
# 
# print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
# print('')
# print('*-*-*-*-*-*-*')
# print('')
# 
# plot(lm_regional)
# 
# aov_regional <- Anova(lm_regional, type = 'II', test.statistic = 'F')
# print(aov_regional)
# 
# print('')
# print('*-*-*-*-*-*-*')
# print('')
# 
# emm_reg_reg <- emmeans(lm_regional, specs = pairwise ~ SubRegion:SubRegion, adjust = 'sidak')
# print(test(emm_reg_reg)$contrasts)
# 
# print('')
# print('*-*-*-*-*-*-*')
# print('')
# 
# emm_reg_WY <- emmeans(lm_regional, specs = pairwise ~ WY:WY, adjust = 'sidak')
# print(test(emm_reg_WY)$contrasts)
```

# Regional Averages per Year (DissOrthophos)
```{r}
print('TEST THINGS')
lm_regional <- lm(DissOrthophos ~ WY + SubRegion, data = df_wq_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_wq_regional$DissOrthophos_onelag <- lag(df_wq_regional$DissOrthophos, n = 1L)
df_wq_regional$DissOrthophos_twolag <- lag(df_wq_regional$DissOrthophos, n = 2L)
df_wq_regional$DissOrthophos_threelag <- lag(df_wq_regional$DissOrthophos, n = 3L)
df_wq_regional$DissOrthophos_fourlag <- lag(df_wq_regional$DissOrthophos, n = 4L)

lm_regional <- lm(DissOrthophos ~ WY + SubRegion  + DissOrthophos_onelag + DissOrthophos_twolag + DissOrthophos_threelag + DissOrthophos_fourlag, data = df_wq_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_regional)

aov_regional <- Anova(lm_regional, type = 'II', test.statistic = 'F')
print(aov_regional)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_reg_reg <- emmeans(lm_regional, specs = pairwise ~ SubRegion:SubRegion, adjust = 'sidak')
print(test(emm_reg_reg)$contrasts)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_reg_WY <- emmeans(lm_regional, specs = pairwise ~ WY:WY, adjust = 'sidak')
print(test(emm_reg_WY)$contrasts)
```


# Regional Averages per Year (DissSilica)
```{r}
print('TEST THINGS')
lm_regional <- lm(DissSilica ~ WY + SubRegion, data = df_wq_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_wq_regional$DissSilica_onelag <- lag(df_wq_regional$DissSilica, n = 1L)
df_wq_regional$DissSilica_twolag <- lag(df_wq_regional$DissSilica, n = 2L)
df_wq_regional$DissSilica_threelag <- lag(df_wq_regional$DissSilica, n = 3L)
df_wq_regional$DissSilica_fourlag <- lag(df_wq_regional$DissSilica, n = 4L)

lm_regional <- lm(DissSilica ~ WY + SubRegion  + DissSilica_onelag + DissSilica_twolag + DissSilica_threelag + DissSilica_fourlag, data = df_wq_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_regional)

aov_regional <- Anova(lm_regional, type = 'II', test.statistic = 'F')
print(aov_regional)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_reg_reg <- emmeans(lm_regional, specs = pairwise ~ SubRegion:SubRegion, adjust = 'sidak')
print(test(emm_reg_reg)$contrasts)

print('')
print('*-*-*-*-*-*-*')
print('')

emm_reg_WY <- emmeans(lm_regional, specs = pairwise ~ WY:WY, adjust = 'sidak')
print(test(emm_reg_WY)$contrasts)
```