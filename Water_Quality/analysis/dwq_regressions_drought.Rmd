```{r}
# Title: Exploratory analysis of WQ data
# Purpose: determine best regressions to use for the drought synthesis project
# Author: Sarah Perry
# Contact: sarah.perry@water.ca.gov
```

```{r}
# library(car)
# library(english)
# library(tseries)
library(tidyverse)
library(lubridate)
library(emmeans)
library(DroughtData)
require(knitr)
require(car)
source('Water_Quality/wq_analysis_funcs.R')
source('Water_Quality/wq_graph_funcs.R')
```

From Dave's Drought package
```{r}
# raw data
df_wq <- raw_nutr_1975_2021

df_wq$DissAmmonia <- replace_rl(df_wq, 'DissAmmonia')
df_wq$DissNitrateNitrite <- replace_rl(df_wq, 'DissNitrateNitrite')
df_wq$DissOrthophos <- replace_rl(df_wq, 'DissOrthophos')

df_wq <- filter(df_wq, Region != 'Suisun Bay')
```

# Dissolved Ammonia
## Seasonal Averages for Entire Delta (DissAmmonia)
```{r}
df_am_seasonal <- drt_avg_data(df = df_wq, data_var = DissAmmonia, avg_type = 'season', month.na = 'relaxed')
df_am_seasonal <- drt_add_yr_assign(df_am_seasonal)
df_am_seasonal$DissAmmonia <- log10(df_am_seasonal$DissAmmonia)

print('TEST THINGS')
lm_seasonal <- lm(DissAmmonia ~ Drought + Season, data = df_am_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_am_seasonal$DissAmmonia_onelag <- lag(df_am_seasonal$DissAmmonia, n = 1L)

lm_seasonal <- lm(DissAmmonia ~ Drought + Season + DissAmmonia_onelag, data = df_am_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_seasonal)

aov_seasonal <- Anova(lm_seasonal, type = 'II', test.statistic = 'F')
print(aov_seasonal)

df_aov <- aov_as_df(aov_seasonal, 'DissAmmonia')
df_aov <- df_aov %>% mutate(`Agg Type` = 'Seasonal', `Avg Type` = 'DI') %>% relocate(`Response Var`, `Agg Type`, `Avg Type`)
write_aov(df_aov, filepath = 'Water_Quality/results/aov_di.csv')

# plts

plt_am_seas <- emm_plotter(lm_seasonal, df_am_seasonal, analyte = 'DissAmmonia', grouping = 'Drought') + theme_bw() + ylab('log(Dissolved Ammonia)')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissAmmonia_di_sea.jpg'), plt_am_seas, width = 7, height = 4.5)
```

# Regional Averages for Entire Delta (DissAmmonia)
```{r}
df_am_regional <- drt_avg_data(df = df_wq, data_var = DissAmmonia, avg_type = 'region', month.na = 'relaxed')
df_am_regional <- drt_add_yr_assign(df_am_regional)
df_am_regional$DissAmmonia <- log10(df_am_regional$DissAmmonia)

print('TEST THINGS')
lm_regional <- lm(DissAmmonia ~ Drought + Region, data = df_am_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_am_regional$DissAM_onelag <- lag(df_am_regional$DissAmmonia, n = 1L)

lm_regional <- lm(DissAmmonia ~ Drought + Region + DissAM_onelag, data = df_am_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_regional)

aov_regional <- Anova(lm_regional, type = 'II', test.statistic = 'F')
print(aov_regional)

df_aov <- aov_as_df(aov_regional, 'DissAmmonia')
df_aov <- df_aov %>% mutate(`Agg Type` = 'Regional', `Avg Type` = 'DI') %>% relocate(`Response Var`, `Agg Type`, `Avg Type`)
write_aov(df_aov, filepath = 'Water_Quality/results/aov_di.csv', space = TRUE, append = TRUE)

# plts

plt_am_reg <- emm_plotter(lm_regional, df_am_regional, analyte = 'DissAmmonia', grouping = 'Drought') + theme_bw() + ylab('log(Dissolved Ammonia)')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissAmmonia_di_reg.jpg'), plt_am_reg, width = 7, height = 4.5)
```

# DissNitrateNitrite
## Seasonal Averages for Entire Delta
```{r message = FALSE}
df_nn_seasonal <- drt_avg_data(df = df_wq, data_var = DissNitrateNitrite, avg_type = 'season', month.na = 'relaxed')
df_nn_seasonal <- drt_add_yr_assign(df_nn_seasonal)
df_nn_seasonal$DissNitrateNitrite <- log10(df_nn_seasonal$DissNitrateNitrite)

print('TEST THINGS')
lm_seasonal <- lm(DissNitrateNitrite ~ Drought + Season, data = df_nn_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_nn_seasonal$DissNN_onelag <- lag(df_nn_seasonal$DissNitrateNitrite, n = 1L)

lm_seasonal <- lm(DissNitrateNitrite ~ Drought + Season + DissNN_onelag, data = df_nn_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_seasonal)

aov_seasonal <- Anova(lm_seasonal, type = 'II', test.statistic = 'F')
print(aov_seasonal)

df_aov <- aov_as_df(aov_seasonal, 'DissNitrateNitrite')
df_aov <- df_aov %>% mutate(`Agg Type` = 'Seasonal', `Avg Type` = 'DI') %>% relocate(`Response Var`, `Agg Type`, `Avg Type`)
write_aov(df_aov, filepath = 'Water_Quality/results/aov_di.csv', space = TRUE, append = TRUE)

# plts

plt_nn_seas <- emm_plotter(lm_seasonal, df_nn_seasonal, analyte = 'DissNitrateNitrite', grouping = 'Drought') +
  theme_bw() +
  ylab('log(Dissolved Nitrate/Nitrite)')

ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissNitrateNitrite_di_sea.jpg'), plt_nn_seas, width = 7, height = 4.5)
```

## Regional Averages for the Entire Delta (DissNitrateNitrite)
```{r}
df_nn_regional <- drt_avg_data(df = df_wq, data_var = DissNitrateNitrite, avg_type = 'region', month.na = 'relaxed')
df_nn_regional <- drt_add_yr_assign(df_nn_regional)
df_nn_regional$DissNitrateNitrite <- log10(df_nn_regional$DissNitrateNitrite)

print('TEST THINGS')
lm_regional <- lm(DissNitrateNitrite ~ Drought + Region, data = df_nn_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_nn_regional$DissNN_onelag <- lag(df_nn_regional$DissNitrateNitrite, n = 1L)

lm_regional <- lm(DissNitrateNitrite ~ Drought + Region + DissNN_onelag, data = df_nn_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_regional)

aov_regional <- Anova(lm_regional, type = 'II', test.statistic = 'F')
print(aov_regional)

df_aov <- aov_as_df(aov_regional, 'DissNitrateNitrite')
df_aov <- df_aov %>% mutate(`Agg Type` = 'Regional', `Avg Type` = 'DI') %>% relocate(`Response Var`, `Agg Type`, `Avg Type`)
write_aov(df_aov, filepath = 'Water_Quality/results/aov_di.csv', space = TRUE, append = TRUE)

# plts

plt_nn_reg <- emm_plotter(lm_regional, df_nn_regional, analyte = 'DissNitrateNitrite', grouping = 'Drought') +
  theme_bw() +
  ylab('log(Dissolved Nitrate/Nitrite)')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissNitrateNitrite_di_reg.jpg'), plt_nn_reg, width = 7, height = 4.5)
```

# Dissolved Orthophosphate
## Seasonal Averages for Entire Delta (DissOrthophos)
```{r}
df_op_seasonal <- drt_avg_data(df = df_wq, data_var = DissOrthophos, avg_type = 'season', month.na = 'relaxed')
df_op_seasonal <- drt_add_yr_assign(df_op_seasonal)
df_op_seasonal$DissOrthophos <- log10(df_op_seasonal$DissOrthophos)

print('TEST THINGS')
lm_seasonal <- lm(DissOrthophos ~ Drought + Season, data = df_op_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_op_seasonal$DissOrthophos_onelag <- lag(df_op_seasonal$DissOrthophos, n = 1L)

lm_seasonal <- lm(DissOrthophos ~ Drought + Season + DissOrthophos_onelag, data = df_op_seasonal)

pacf(residuals(lm_seasonal), na.action = na.pass)

print(stats::Box.test(residuals(lm_seasonal), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_seasonal)

aov_seasonal <- Anova(lm_seasonal, type = 'II', test.statistic = 'F')
print(aov_seasonal)

df_aov <- aov_as_df(aov_seasonal, 'DissOrthophos')
df_aov <- df_aov %>% mutate(`Agg Type` = 'Seasonal', `Avg Type` = 'DI') %>% relocate(`Response Var`, `Agg Type`, `Avg Type`)
write_aov(df_aov, filepath = 'Water_Quality/results/aov_di.csv', space = TRUE, append = TRUE)

# plts

plt_op_seas <- emm_plotter(lm_seasonal, df_op_seasonal, analyte = 'DissOrthophos', grouping = 'Drought') + theme_bw() + ylab('log(Dissolved Orthophosphate)')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissOrthophos_di_sea.jpg'), plt_op_seas, width = 7, height = 4.5)
```

# Regional Averages for the Entire Delta (DissOrthophos)
```{r}
df_op_regional <- drt_avg_data(df = df_wq, data_var = DissOrthophos, avg_type = 'region', month.na = 'relaxed')
df_op_regional <- drt_add_yr_assign(df_op_regional)
df_op_regional$DissOrthophos <- log10(df_op_regional$DissOrthophos)

print('TEST THINGS')
lm_regional <- lm(DissOrthophos ~ Drought + Region, data = df_op_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))

print('')
print('END TEST THINGS')
print('')

# failed tests, add lags based on pacf
df_op_regional$DissOrthophos_onelag <- lag(df_op_regional$DissOrthophos, n = 1L)

lm_regional <- lm(DissOrthophos ~ Drought + Region  + DissOrthophos_onelag, data = df_op_regional)

pacf(residuals(lm_regional), na.action = na.pass)

print(stats::Box.test(residuals(lm_regional), type = 'Ljung'))
print('')
print('*-*-*-*-*-*-*')
print('')

plot(lm_regional)

aov_regional <- Anova(lm_regional, type = 'II', test.statistic = 'F')
print(aov_regional)

df_aov <- aov_as_df(aov_regional, 'DissOrthophos')
df_aov <- df_aov %>% mutate(`Agg Type` = 'Regional', `Avg Type` = 'DI') %>% relocate(`Response Var`, `Agg Type`, `Avg Type`)
write_aov(df_aov, filepath = 'Water_Quality/results/aov_di.csv', space = TRUE, append = TRUE)

#plts

plt_op_reg <- emm_plotter(lm_regional, df_op_regional, analyte = 'DissOrthophos', grouping = 'Drought') + theme_bw() + ylab('log(Dissolved Orthophosphate)')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissOrthophos_di_reg.jpg'), plt_op_reg, width = 7, height = 4.5)
```

```{r}
# save plots
# dissam
plt_am_reg <- plt_am_reg + ylab(NULL) + xlab('Drought (Regional Averages)')
plt_am_seas <- plt_am_seas + xlab('Drought (Seasonal Averages)')

bp_em_DissAmmonia_di_both <- cowplot::plot_grid(plotlist = list(plt_am_seas, plt_am_reg), labels = 'auto')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissAmmonia_di_both.jpg'), bp_em_DissAmmonia_di_both, width = 8, height = 3.5)

# dissnn
plt_nn_reg <- plt_nn_reg + ylab(NULL) + xlab('Drought (Regional Averages)')
plt_nn_seas <- plt_nn_seas + xlab('Drought (Seasonal Averages)')

bp_em_DissNitrateNitrite_di_both <- cowplot::plot_grid(plotlist = list(plt_nn_seas, plt_nn_reg), labels = 'auto')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissNitrateNitrite_di_both.jpg'), bp_em_DissNitrateNitrite_di_both, width = 8, height = 3.5)

# dissorthophos
plt_op_reg <- plt_op_reg + ylab(NULL) + xlab('Drought (Regional Averages)')
plt_op_seas <- plt_op_seas + xlab('Drought (Seasonal Averages)')

bp_em_DissOrthophos_di_both <- cowplot::plot_grid(plotlist = list(plt_op_seas, plt_op_reg), labels = 'auto')
ggsave(paste0(getwd(),'/Water_Quality/plots/bp_em_DissOrthophos_di_both.jpg'), bp_em_DissOrthophos_di_both, width = 8, height = 3.5)
```

